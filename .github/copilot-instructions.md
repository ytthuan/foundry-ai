# Copilot Instructions for Deep Research Workflow

- Workflows live in [ai-foundry-new/workflows/current-deep-research-workflow-v2.yaml](ai-foundry-new/workflows/current-deep-research-workflow-v2.yaml) (Bing/WebSearch + sources) and [ai-foundry-new/workflows/current-deep-research-internally-workflow.yaml](ai-foundry-new/workflows/current-deep-research-internally-workflow.yaml) (InternalSearch only). Update the right one; do not add YAML comments anywhere.
- Agents and schemas are paired: YAML definitions in [ai-foundry-new/agents](ai-foundry-new/agents) and strict JSON Schemas in [ai-foundry-new/schemas](ai-foundry-new/schemas). Keep `response_format.json_schema.strict: true` and `additionalProperties: false`; avoid nested objects inside arrays—use parallel primitive arrays (`queries`, `research_goals`, etc.).
- Expressions are Power Fx, not JavaScript: prefix with `=`, use `Concatenate()`/`Concat()` for strings and tables, `Char(10)` for newlines, `Sequence()` + `Index(...).Value` for 1-based access. Do not use `ForEach`; loop with `ConditionGroup` + `GotoAction` as shown in both workflows.
- Accumulators are strings: append learnings/follow-ups with `Concatenate`/`Concat` instead of overwriting. Reset `Local.all_iteration_followups` each depth iteration; append per query; append sources in V2 before final report.
- Web search content comes back as a `messages` table; convert to text with `Concat(Local.web_search_results, Text, Char(10))` before passing to LearningsAgent. Keep follow-up questions aggregated before updating `Local.enriched_query`.
- Default run paths: V2 starts with depth=2/breadth=3 and uses WebSearchAgent → LearningsAgent → ReportAgent; internal workflow defaults to depth=1/breadth=1 and swaps WebSearchAgent for InternalSearchAgent. Both collect clarifications first, then title, iterate queries, and finish with ReportAgent.
- Agent template: `type: foundry_agent`, `model.id: ${AzureAI:ChatModelId}`, optional `temperature`/`max_tokens`; only WebSearchAgent declares `tools: - type: bing_grounding`. Keep instructions concise and schemas capped at ~3 items per list.
- Python utilities: [src/utils/create_or_update_agents.py](src/utils/create_or_update_agents.py) loads all agent YAMLs and creates/updates them in Azure AI Foundry (requires `AZURE_AI_PROJECT_ENDPOINT`/`AZURE_AIPROJECT_ENDPOINT`, DefaultAzureCredential, optional .env). [src/utils/update_foundry_agents.py](src/utils/update_foundry_agents.py) bulk-tunes agents (MCP require_approval, GPT-5 temperature removal). Run via `python <script>` after setting the endpoint.
- Quick test tips: run workflows in Foundry with depth=1, breadth=1 for speed; sample prompt in [README.md](README.md) (“Sugar effect to human brain?”). Use Foundry execution traces to debug data flow and iterator state.

If anything is unclear or missing for this repo, tell me what to refine.
